<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Tag Management</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        .tag { display: inline-block; padding: 5px 10px; margin: 5px; border-radius: 15px; color: white; }
        .log { background-color: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0; font-family: monospace; }
    </style>
</head>
<body>
    <h1>üîç Debug Tag Management</h1>
    
    <div class="debug-section info">
        <h3>üìã Test Information</h3>
        <p><strong>API Base:</strong> <span id="api-base">http://localhost:4002</span></p>
        <p><strong>API Key:</strong> <span id="api-key">my-secret-api-key-123</span></p>
        <p><strong>Status:</strong> <span id="status">Ready to test</span></p>
    </div>

    <div class="debug-section">
        <h3>üß™ Test Controls</h3>
        <button class="btn-primary" onclick="testBackendConnection()">Test Backend Connection</button>
        <button class="btn-primary" onclick="fetchTags()">Fetch All Tags</button>
        <button class="btn-primary" onclick="fetchContacts()">Fetch Contacts</button>
        <button class="btn-success" onclick="testTagApplication()">Test Tag Application</button>
        <button class="btn-danger" onclick="clearLogs()">Clear Logs</button>
    </div>

    <div class="debug-section">
        <h3>üìä Data Display</h3>
        <div id="tags-display">
            <h4>Tags: <span id="tags-count">0</span></h4>
            <div id="tags-list"></div>
        </div>
        <div id="contacts-display">
            <h4>Contacts: <span id="contacts-count">0</span></h4>
            <div id="contacts-list"></div>
        </div>
    </div>

    <div class="debug-section">
        <h3>üìù Debug Logs</h3>
        <div id="logs"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:4002';
        const API_KEY = 'my-secret-api-key-123';
        let currentTags = [];
        let currentContacts = [];
        let selectedContact = null;
        let selectedTag = null;

        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log ${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function updateStatus(message, type = 'info') {
            document.getElementById('status').textContent = message;
            document.getElementById('status').className = type;
        }

        async function testBackendConnection() {
            try {
                log('üîç Testing backend connection...');
                updateStatus('Testing connection...', 'info');
                
                const response = await fetch(`${API_BASE}/health`, {
                    headers: { 'X-API-Key': API_KEY }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Backend connected successfully: ${JSON.stringify(data)}`, 'success');
                    updateStatus('Backend connected', 'success');
                } else {
                    log(`‚ùå Backend connection failed: ${response.status} ${response.statusText}`, 'error');
                    updateStatus('Backend connection failed', 'error');
                }
            } catch (error) {
                log(`‚ùå Connection error: ${error.message}`, 'error');
                updateStatus('Connection error', 'error');
            }
        }

        async function fetchTags() {
            try {
                log('üè∑Ô∏è Fetching tags...');
                updateStatus('Fetching tags...', 'info');
                
                const response = await fetch(`${API_BASE}/tags`, {
                    headers: { 'X-API-Key': API_KEY }
                });
                
                if (response.ok) {
                    currentTags = await response.json();
                    log(`‚úÖ Fetched ${currentTags.length} tags`, 'success');
                    updateStatus(`Fetched ${currentTags.length} tags`, 'success');
                    displayTags();
                } else {
                    log(`‚ùå Failed to fetch tags: ${response.status} ${response.statusText}`, 'error');
                    updateStatus('Failed to fetch tags', 'error');
                }
            } catch (error) {
                log(`‚ùå Error fetching tags: ${error.message}`, 'error');
                updateStatus('Error fetching tags', 'error');
            }
        }

        async function fetchContacts() {
            try {
                log('üë• Fetching contacts...');
                updateStatus('Fetching contacts...', 'info');
                
                const response = await fetch(`${API_BASE}/contacts?limit=5`, {
                    headers: { 'X-API-Key': API_KEY }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentContacts = data.data || [];
                    log(`‚úÖ Fetched ${currentContacts.length} contacts`, 'success');
                    updateStatus(`Fetched ${currentContacts.length} contacts`, 'success');
                    displayContacts();
                } else {
                    log(`‚ùå Failed to fetch contacts: ${response.status} ${response.statusText}`, 'error');
                    updateStatus('Failed to fetch contacts', 'error');
                }
            } catch (error) {
                log(`‚ùå Error fetching contacts: ${error.message}`, 'error');
                updateStatus('Error fetching contacts', 'error');
            }
        }

        function displayTags() {
            const tagsList = document.getElementById('tags-list');
            const tagsCount = document.getElementById('tags-count');
            
            tagsCount.textContent = currentTags.length;
            tagsList.innerHTML = '';
            
            currentTags.forEach(tag => {
                const tagDiv = document.createElement('div');
                tagDiv.className = 'tag';
                tagDiv.style.backgroundColor = tag.color || '#007bff';
                tagDiv.textContent = tag.name;
                tagDiv.onclick = () => selectTag(tag);
                tagDiv.style.cursor = 'pointer';
                tagsList.appendChild(tagDiv);
            });
        }

        function displayContacts() {
            const contactsList = document.getElementById('contacts-list');
            const contactsCount = document.getElementById('contacts-count');
            
            contactsCount.textContent = currentContacts.length;
            contactsList.innerHTML = '';
            
            currentContacts.forEach(contact => {
                const contactDiv = document.createElement('div');
                contactDiv.style.padding = '10px';
                contactDiv.style.margin = '5px';
                contactDiv.style.border = '1px solid #ddd';
                contactDiv.style.borderRadius = '5px';
                contactDiv.style.cursor = 'pointer';
                contactDiv.innerHTML = `
                    <strong>${contact.name}</strong> (${contact.id})<br>
                    <small>${contact.email || 'No email'}</small>
                `;
                contactDiv.onclick = () => selectContact(contact);
                contactsList.appendChild(contactDiv);
            });
        }

        function selectTag(tag) {
            selectedTag = tag;
            log(`üè∑Ô∏è Selected tag: ${tag.name}`, 'info');
            document.querySelectorAll('#tags-list .tag').forEach(t => t.style.border = '2px solid #ddd');
            event.target.style.border = '2px solid #28a745';
        }

        function selectContact(contact) {
            selectedContact = contact;
            log(`üë§ Selected contact: ${contact.name}`, 'info');
            document.querySelectorAll('#contacts-list div').forEach(c => c.style.border = '1px solid #ddd');
            event.target.style.border = '2px solid #28a745';
        }

        async function testTagApplication() {
            if (!selectedContact || !selectedTag) {
                log('‚ùå Please select both a contact and a tag first', 'error');
                return;
            }

            try {
                log(`üöÄ Testing tag application: "${selectedTag.name}" to "${selectedContact.name}"...`);
                updateStatus('Testing tag application...', 'info');
                
                const response = await fetch(`${API_BASE}/tags/contacts/${selectedContact.id}/tags/${selectedTag.id}`, {
                    method: 'POST',
                    headers: {
                        'X-API-Key': API_KEY,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    log(`‚úÖ Tag "${selectedTag.name}" applied successfully to "${selectedContact.name}"!`, 'success');
                    updateStatus('Tag applied successfully', 'success');
                } else if (response.status === 409) {
                    const data = await response.json();
                    log(`‚ÑπÔ∏è Tag already applied: ${data.message}`, 'info');
                    updateStatus('Tag already applied', 'info');
                } else {
                    const errorData = await response.text();
                    log(`‚ùå Failed to apply tag: ${response.status} ${response.statusText} - ${errorData}`, 'error');
                    updateStatus('Failed to apply tag', 'error');
                }
            } catch (error) {
                log(`‚ùå Error applying tag: ${error.message}`, 'error');
                updateStatus('Error applying tag', 'error');
            }
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            log('üßπ Logs cleared', 'info');
        }

        // Auto-test on load
        window.onload = function() {
            log('üöÄ Debug page loaded, ready to test tag management', 'info');
            testBackendConnection();
        };
    </script>
</body>
</html>
